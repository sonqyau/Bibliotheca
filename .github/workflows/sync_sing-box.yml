name: Sync sing-box

permissions:
  contents: write
  actions: write

on:
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:
    inputs:
      sync:
        description: "Sync"
        type: boolean
        default: true
      build:
        description: "Build type"
        required: true
        type: choice
        default: "ALL"
        options:
          - ALL
          - Binary
          - macOS
          - SKIP
      version:
        description: "Version"
        type: string
        required: false

concurrency:
  group: sync-build-sing-box
  cancel-in-progress: true

env:
  UPSTREAM_REPO: "SagerNet/sing-box"
  UPSTREAM_BRANCH: "dev-next"

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      should_sync: ${{ steps.out.outputs.should_sync }}
      build_types: ${{ steps.out.outputs.build_types }}
    steps:
      - id: out
        shell: bash
        run: |
          sync_val="${{ inputs.sync || 'true' }}"
          mode_val="${{ inputs.build || 'ALL' }}"
          if [[ "$sync_val" != "true" ]]; then
            printf 'should_sync=false\n' >> "$GITHUB_OUTPUT"
          else
            printf 'should_sync=true\n' >> "$GITHUB_OUTPUT"
          fi
          case "$mode_val" in
            ALL)
              printf 'build_types=["binary","macos"]\n' >> "$GITHUB_OUTPUT"
              ;;
            Binary)
              printf 'build_types=["binary"]\n' >> "$GITHUB_OUTPUT"
              ;;
            macOS)
              printf 'build_types=["macos"]\n' >> "$GITHUB_OUTPUT"
              ;;
            *)
              printf 'build_types=[]\n' >> "$GITHUB_OUTPUT"
              ;;
          esac

  sync:
    if: needs.plan.outputs.should_sync == 'true'
    runs-on: ubuntu-latest
    needs: plan
    outputs:
      changes: ${{ steps.sync.outputs.changes }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: "${{ secrets.PAT }}"
          ref: main
          submodules: recursive
      - id: sync
        shell: bash
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global advice.detachedHead false
          cd sing-box
          git remote remove upstream 2>/dev/null || true
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git"
          git fetch upstream "${{ env.UPSTREAM_BRANCH }}" --depth=1
          cur_sha="$(git rev-parse HEAD)"
          up_sha="$(git rev-parse "upstream/${{ env.UPSTREAM_BRANCH }}")"
          if [[ "$cur_sha" == "$up_sha" ]]; then
            printf 'changes=false\n' >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git checkout "$up_sha"
          cd ..
          git add sing-box
          if git diff --cached --quiet; then
            printf 'changes=false\n' >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "feat(sing-box): bump ${up_sha:0:7} [$(date -u +%FT%TZ)]"
          git remote set-url origin "https://user:${{ secrets.PAT }}@github.com/${{ github.repository }}.git"
          git pull --rebase --autostash origin main
          git push origin HEAD:main
          printf 'changes=true\n' >> "$GITHUB_OUTPUT"
          printf 'upstream_sha=%s\n' "$up_sha" >> "$GITHUB_ENV"

  build-binary:
    if: contains(needs.plan.outputs.build_types, 'binary') && needs.sync.outputs.changes == 'true'
    runs-on: macos-latest
    needs: sync
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive
      - uses: actions/setup-go@v6
        with:
          go-version: "^1.25.3"
          cache: true
      - run: |
          cd sing-box
          VERSION='${{ inputs.version || github.sha }}'
          TAGS='with_gvisor,with_quic,with_dhcp,with_wireguard,with_utls,with_acme,with_clash_api,with_tailscale'
          go build -trimpath -ldflags="-s -w -buildid= -X github.com/sagernet/sing-box/constant.Version=$VERSION" -tags="$TAGS" -o sing-box ./cmd/sing-box
          PKG="sing-box-$VERSION-${{ runner.os }}-$(go env GOARCH)"
          mkdir "$PKG"
          cp LICENSE sing-box "$PKG/"
          if ! command -v zstd >/dev/null; then
            brew install zstd gnu-tar
          fi
          gtar --zstd -cf "$PKG.tar.zst" "$PKG"
      - uses: actions/upload-artifact@v5
        with:
          name: binary
          path: sing-box/*.tar.zst
          retention-days: 7

  build-macos:
    if: contains(needs.plan.outputs.build_types, 'macos') && needs.sync.outputs.changes == 'true'
    runs-on: macos-26
    needs: sync
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive
      - uses: actions/setup-go@v6
        with:
          go-version: "^1.25.3"
          cache: true
      - run: |
          cd sing-box
          if [ ! -d "clients/apple" ]; then
            exit 0
          fi
          if ! command -v create-dmg >/dev/null; then
            brew install create-dmg zstd gnu-tar
          fi
          GOPATH_BIN="$(go env GOPATH)/bin"
          export PATH="$PATH:$GOPATH_BIN"
          make lib_install
          go run ./cmd/internal/build_libbox -target apple -platform macos
          mv Libbox.xcframework clients/apple/
          cd clients/apple
          [ -f "sing-box.xcodeproj/project.pbxproj" ] || exit 0
          sed -i '' 's/CODE_SIGN_STYLE = Automatic/CODE_SIGN_STYLE = Manual/g; s/CODE_SIGN_IDENTITY = .*/CODE_SIGN_IDENTITY = "";/g; s/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "";/g' sing-box.xcodeproj/project.pbxproj
          xcodebuild build -scheme SFM.System -configuration Release -destination "generic/platform=macOS" -derivedDataPath ./DD CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO ONLY_ACTIVE_ARCH=NO
          APP=$(find . -name "*.app" -type d -print -quit)
          if [ -z "$APP" ]; then
            exit 0
          fi
          VERSION='${{ inputs.version || github.sha }}'
          DMG="SFM-$VERSION.dmg"
          create-dmg --volname "SFM" --app-drop-link 200 200 --skip-jenkins "$DMG" "$APP"
          mv "$DMG" ../../
          cd ../..
          gtar --zstd -cf "$DMG.tar.zst" "$DMG"
      - uses: actions/upload-artifact@v5
        with:
          name: macos
          path: sing-box/*.tar.zst
          retention-days: 7
          if-no-files-found: ignore
