name: Sync BrightIntosh

permissions:
  contents: write
  actions: write

on:
  schedule:
    - cron: "0 19 * * *"
  workflow_dispatch:
    inputs:
      sync:
        description: "Sync"
        type: boolean
        default: true
      build:
        description: "Build type"
        required: true
        type: choice
        default: "macOS"
        options:
          - macOS
          - SKIP
      version:
        description: "Version"
        type: string
        required: false

concurrency:
  group: sync-build-brightintosh
  cancel-in-progress: true

env:
  UPSTREAM_REPO: "niklasr22/BrightIntosh"
  UPSTREAM_BRANCH: "main"

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      should_sync: ${{ steps.out.outputs.should_sync }}
      build_types: ${{ steps.out.outputs.build_types }}
    steps:
      - id: out
        shell: bash
        run: |
          sync_val="${{ inputs.sync || 'true' }}"
          mode_val="${{ inputs.build || 'macOS' }}"
          if [[ "$sync_val" != "true" ]]; then
            printf 'should_sync=false\n' >> "$GITHUB_OUTPUT"
          else
            printf 'should_sync=true\n' >> "$GITHUB_OUTPUT"
          fi
          case "$mode_val" in
            macOS)
              printf 'build_types=["macos"]\n' >> "$GITHUB_OUTPUT"
              ;;
            *)
              printf 'build_types=[]\n' >> "$GITHUB_OUTPUT"
              ;;
          esac

  sync:
    if: needs.plan.outputs.should_sync == 'true'
    runs-on: ubuntu-latest
    needs: plan
    outputs:
      changes: ${{ steps.sync.outputs.changes }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: "${{ secrets.PAT }}"
          ref: main
          submodules: recursive
      - id: sync
        shell: bash
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global advice.detachedHead false
          cd BrightIntosh
          git remote remove upstream 2>/dev/null || true
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git"
          git fetch upstream "${{ env.UPSTREAM_BRANCH }}" --depth=1
          cur_sha="$(git rev-parse HEAD)"
          up_sha="$(git rev-parse "upstream/${{ env.UPSTREAM_BRANCH }}")"
          if [[ "$cur_sha" == "$up_sha" ]]; then
            printf 'changes=false\n' >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git checkout "$up_sha"
          cd ..
          git add BrightIntosh
          if git diff --cached --quiet; then
            printf 'changes=false\n' >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git commit -m "feat(BrightIntosh): bump ${up_sha:0:7} [$(date -u +%FT%TZ)]"
          git remote set-url origin "https://user:${{ secrets.PAT }}@github.com/${{ github.repository }}.git"
          git push origin main
          printf 'changes=true\n' >> "$GITHUB_OUTPUT"
          printf 'upstream_sha=%s\n' "$up_sha" >> "$GITHUB_ENV"

  build:
    if: contains(needs.plan.outputs.build_types, 'macos') && (needs.sync.outputs.changes == 'true' || github.event_name == 'workflow_dispatch')
    runs-on: macos-26
    needs: sync
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          submodules: recursive
      - shell: bash
        run: |
          cd BrightIntosh
          [[ -d BrightIntosh.xcodeproj ]] || exit 0
          command -v create-dmg >/dev/null || brew install create-dmg zstd gnu-tar
          xcodebuild build -scheme BrightIntosh -configuration Release -destination "generic/platform=macOS" -derivedDataPath ./DD CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO ONLY_ACTIVE_ARCH=NO
          app_path="$(find ./DD -name 'BrightIntosh.app' -type d -print -quit)"
          [[ -n "$app_path" ]] || exit 0
          ver='${{ inputs.version || github.sha }}'
          dmg="BrightIntosh-${ver}.dmg"
          create-dmg --volname BrightIntosh --app-drop-link 200 200 --skip-jenkins "$dmg" "$app_path"
          gtar --zstd -cf "$dmg.tar.zst" "$dmg"
      - uses: actions/upload-artifact@v5
        with:
          name: macos
          path: BrightIntosh/*.tar.zst
          retention-days: 7
          if-no-files-found: ignore
